<div class="card shadow-sm p-4">

  <form #form="ngForm" (ngSubmit)="saveTimesheet(form)">

    <div class="row g-3 mb-3">

      <div class="col-md-4">
        <label class="form-label">Employee Name</label>
        <input class="form-control" [(ngModel)]="model.employeeName" name="employeeName" readonly>
      </div>

      <div class="col-md-4">
        <label class="form-label">Employee Code</label>
        <input class="form-control" [(ngModel)]="model.employeeCode" name="employeeCode" readonly>
      </div>

      <div class="col-md-4">
        <label class="form-label">Date</label>
        <input type="date" class="form-control" [(ngModel)]="model.date" name="date" required>
      </div>

      <div class="col-md-8">
        <label class="form-label">Comments</label>
        <textarea class="form-control" [(ngModel)]="model.comments" name="comments"></textarea>
      </div>

      <div class="col-md-4">
        <label class="form-label">Attachment</label>
        <input type="file" class="form-control" (change)="onFileSelect($event)">
      </div>

    </div>

    <h6 class="mt-2">Projects</h6>

    <div *ngFor="let p of model.projects; let i = index" class="row g-2 align-items-end mb-2">

      <div class="col-md-3">
        <label>Project {{ i + 1 }}</label>
        <input class="form-control" [(ngModel)]="p.projectName" name="project{{i}}" required>
      </div>

      <div class="col-md-2">
        <label>Start Time</label>
        <input type="time" class="form-control"
               [(ngModel)]="p.startTime"
               name="start{{i}}"
               (change)="calculateProjectHours(p)">
      </div>

      <div class="col-md-2">
        <label>End Time</label>
        <input type="time" class="form-control"
               [(ngModel)]="p.endTime"
               name="end{{i}}"
               (change)="calculateProjectHours(p)">
      </div>

      <div class="col-md-2">
        <label>Total Hours</label>
        <input class="form-control" [value]="p.totalHoursText" readonly>
      </div>

      <div class="col-md-2">
        <label>OT Hours</label>
        <input class="form-control"
               [(ngModel)]="p.overtimeHours"
               name="ot{{i}}"
               placeholder="HH:MM or 1.5"
               (change)="calculateProjectHours(p)">
      </div>

      <div class="col-md-1 text-center">
        <button type="button" class="btn btn-danger btn-sm" (click)="removeProject(i)">
          <i class="fa-solid fa-trash"></i>
        </button>
      </div>

    </div>

    <button type="button" class="btn btn-secondary btn-sm mt-2" (click)="addProject()">
      <i class="fa-solid fa-plus me-2"></i> Add Project
    </button>

    <div class="text-end mt-4">
      <button class="btn btn-success" type="submit" [disabled]="!form.valid">
        Save Timesheet
      </button>
    </div>

  </form>
</div>

<!-- ================= SUBMITTED LIST ================= -->

<!-- ================= SUBMITTED LIST ================= -->
<div class="dashboard-tables full-row mt-4">
  <div class="table-card">
    <h3>Submitted Timesheets</h3>
    <button class="btn btn-primary mb-2" (click)="sendSelectedTimesheets()">
      <i class="fa-solid fa-paper-plane me-2"></i> Send Selected
    </button>

    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th><input type="checkbox" (change)="toggleSelectAll($event)"></th>
          <th (click)="sortBy('employeeName')" style="cursor:pointer">
            Employee Name
            <span *ngIf="sortColumn==='employeeName'">{{ sortDirection==='asc'?'▲':'▼' }}</span>
          </th>
          <th (click)="sortBy('employeeCode')" style="cursor:pointer">
            Employee ID
            <span *ngIf="sortColumn==='employeeCode'">{{ sortDirection==='asc'?'▲':'▼' }}</span>
          </th>
          <th (click)="sortBy('timesheetDate')" style="cursor:pointer">
            Date
            <span *ngIf="sortColumn==='timesheetDate'">{{ sortDirection==='asc'?'▲':'▼' }}</span>
          </th>
          <th>Projects</th>
          <th (click)="sortBy('totalHoursText')" style="cursor:pointer">
            Total Hours
            <span *ngIf="sortColumn==='totalHoursText'">{{ sortDirection==='asc'?'▲':'▼' }}</span>
          </th>
          <th (click)="sortBy('otHoursText')" style="cursor:pointer">
            OT Hours
            <span *ngIf="sortColumn==='otHoursText'">{{ sortDirection==='asc'?'▲':'▼' }}</span>
          </th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of filteredTimesheets(); let i = index">
          <td><input type="checkbox" [(ngModel)]="row.selected" [disabled]="row.status !== 'Pending'"></td>
          <td>{{ row.employeeName }}</td>
          <td>{{ row.employeeCode }}</td>
          <td>{{ row.timesheetDate | date:'dd-MMM-yyyy' }}</td>
          <td>
            <ul class="list-group list-group-flush">
              <li class="list-group-item py-1" *ngFor="let p of row.projects; let pi = index">
                Project {{ pi + 1 }}: {{ p.projectName }}
              </li>
            </ul>
          </td>
          <td>
            <ul class="list-group list-group-flush">
              <li class="list-group-item py-1" *ngFor="let p of row.projects">
                {{ p.totalHoursText }}
              </li>
            </ul>
          </td>
          <td>
            <ul class="list-group list-group-flush">
              <li class="list-group-item py-1" *ngFor="let p of row.projects">
                {{ p.otHoursText || '0 Hours' }}
              </li>
            </ul>
          </td>
          <td>
            <span class="badge" [ngClass]="{
              'bg-warning': row.status==='Pending',
              'bg-primary': row.status==='Submitted',
              'bg-success': row.status==='Approved',
              'bg-danger': row.status==='Rejected'
            }">{{ row.status }}</span>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-2">
      <div>
        <label>Show:
          <select class="form-select d-inline w-auto ms-2" [(ngModel)]="pageSize" (change)="changePageSize(pageSize)">
            <option *ngFor="let size of pageSizeOptions" [ngValue]="size">{{ size }}</option>
          </select> entries
        </label>
      </div>
      <div>
        <button class="btn btn-outline-secondary btn-sm me-2" (click)="changePage(currentPage-1)" [disabled]="currentPage===1">Previous</button>
        <span>Page {{ currentPage }} of {{ totalPages }}</span>
        <button class="btn btn-outline-secondary btn-sm ms-2" (click)="changePage(currentPage+1)" [disabled]="currentPage===totalPages">Next</button>
      </div>
    </div>
  </div>
</div>