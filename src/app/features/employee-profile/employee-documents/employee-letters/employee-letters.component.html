<form #letterForm="ngForm" (ngSubmit)="saveLetter(letterForm)">

  <div class="row mb-3">
    <div class="col-md-4">
       <label class="form-label">
        Document Type <span class="text-danger">*</span>
      </label>
       <select class="form-select"
            required
            [(ngModel)]="form.documentType"
            name="documentType"
            #documentType="ngModel">
      <option value="">Select Document Type</option>
      <option *ngFor="let doc of documentTypes" [value]="doc.id">{{ doc.typeName }}</option>
    </select>

    <div *ngIf="documentType.invalid && documentType.touched" class="text-danger">
      Document type is required.
    </div>


    </div>

    <div class="col-md-4">
      <label class="form-label">
        Document Title / Name <span class="text-danger">*</span>
      </label>
      <input type="text"
          class="form-control"
          required
          maxlength="150"
          [(ngModel)]="form.title"
          name="title"
          #title="ngModel"
          placeholder="Enter Document Title">

    <div *ngIf="title.invalid && title.touched" class="text-danger">
      <div *ngIf="title.errors?.['required']">Document title is required.</div>
      <div *ngIf="title.errors?.['maxlength']">Max 150 characters allowed.</div>
    </div>

    </div>

    <div class="col-md-4">
      <label class="form-label">Employee Code / ID <span class="text-danger">*</span></label>
      <input type="text"
          class="form-control"
          maxlength="50"
          required
          [(ngModel)]="form.empCode"
          name="empCode"
          #empCode="ngModel"
          placeholder="Enter Employee Code / ID">

    <div *ngIf="empCode.invalid && empCode.touched" class="text-danger">
      <div *ngIf="empCode.errors?.['required']">Employee Code is required.</div>
      <div *ngIf="empCode.errors?.['maxlength']">Max 50 characters allowed.</div>
    </div>

    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label">Employee Name <span class="text-danger">*</span></label>
     <input type="text"
            class="form-control"
            required
            maxlength="100"
            pattern="^[A-Za-z ]+$"
            [(ngModel)]="form.empName"
            name="empName"
            #empName="ngModel"
            placeholder="Enter Employee Name">

      <div *ngIf="empName.invalid && empName.touched" class="text-danger">
        <div *ngIf="empName.errors?.['required']">Employee name is required.</div>
        <div *ngIf="empName.errors?.['pattern']">Only letters & spaces allowed.</div>
        <div *ngIf="empName.errors?.['maxlength']">Max 100 characters allowed.</div>
      </div>

    </div>

    <div class="col-md-4">
       <label class="form-label">
        Issued Date <span class="text-danger">*</span>
      </label>
      <input type="date"
            class="form-control"
            required
            [max]="today"
            [(ngModel)]="form.issuedDate"
            name="issuedDate"
            #issuedDate="ngModel">

      <div *ngIf="issuedDate.invalid && issuedDate.touched" class="text-danger">
        <div *ngIf="issuedDate.errors?.['required']">Issued date is required.</div>
        <div *ngIf="issuedDate.errors?.['max']">Cannot select future date.</div>
      </div>

    </div>

    <div class="col-md-4">
      <label class="form-label">Validity Date </label>
      <input type="date"
            class="form-control"
            [min]="form.issuedDate"
            [(ngModel)]="form.validityDate"
            name="validityDate"
            #validityDate="ngModel">

      <div *ngIf="validityDate.invalid && validityDate.touched" class="text-danger">
        <div *ngIf="validityDate.errors?.['min']">
          Validity date must be on/after issued date.
        </div>
      </div>

    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label">Upload File <span class="text-danger">*</span></label>
     <input type="file"
            class="form-control"
            required
            (change)="onFileSelected($event)"
            #fileInput="ngModel"
            name="fileInput"
            ngModel>

      <div *ngIf="!selectedFile && fileInput.touched" class="text-danger">
        File is required.
      </div>

    </div>

    <div class="col-md-4">
      <label class="form-label">Remarks / Notes</label>
      <textarea class="form-control" [(ngModel)]="form.remarks" name="remarks"></textarea>
    </div>

    <div class="col-md-4 d-flex align-items-center">
      <div class="form-check mt-4">
        <input class="form-check-input" type="checkbox" [(ngModel)]="form.confidential" name="confidential">
        <label class="form-check-label">Mark as Confidential</label>
      </div>
    </div>
  </div>

  <div class="mt-2">
  <button type="submit" class="btn btn-primary me-2">
    {{ isEdit ? 'Update Letter' : 'Save Letter' }}
  </button>

  <button type="button" class="btn btn-primary" (click)="resetFormFields()">
    Reset
  </button>
</div>

</form>

<!-- Table -->
<div class="dashboard-tables full-row mt-4">
  <div class="table-card">
    <h3>Letters List</h3>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>S.No</th>

          <th (click)="sortBy('documentType')" style="cursor:pointer">
            Document Type
            <span *ngIf="sortColumn === 'documentType'">
              {{ sortDirection === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th (click)="sortBy('title')" style="cursor:pointer">
            Document Title
            <span *ngIf="sortColumn === 'title'">
              {{ sortDirection === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th (click)="sortBy('empName')" style="cursor:pointer">
            Employee Code And Name
            <span *ngIf="sortColumn === 'empName'">
              {{ sortDirection === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th (click)="sortBy('issuedDate')" style="cursor:pointer">
            Issued Date
            <span *ngIf="sortColumn === 'issuedDate'">
              {{ sortDirection === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th (click)="sortBy('validityDate')" style="cursor:pointer">
            Validity
            <span *ngIf="sortColumn === 'validityDate'">
              {{ sortDirection === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th>File</th>
          <th>Actions</th>
        </tr>
      </thead>


      <tbody>
        <tr *ngFor="let l of filteredLetters(); let i = index">
          <td>{{ (currentPage - 1) * pageSize + i + 1 }}</td>
          <td>{{ l.documentType }}</td>
          <td>{{ l.title }}</td>
          <td>{{ l.empCode }} - {{ l.empName }}</td>
          <td>{{ l.issuedDate }}</td>
          <td>{{ l.validityDate || '-' }}</td>
          <td>
            <a *ngIf="l.fileName"
              style="cursor:pointer; color:#0d6efd; font-weight:500;"
              (click)="viewDocument(l.fileName)">
              View
            </a>
          </td>

          <td class="action-icons">
            <i class="fa-solid fa-pen me-2" style="color: black;" (click)="editLetter(l)"></i>
            <i class="fa-solid fa-trash" style="color: black;" (click)="deleteLetter(l.id)"></i>
          </td>
        </tr>
      </tbody>

    </table>
  </div>
</div>

<!-- Pagination Footer -->
<div class="d-flex justify-content-between align-items-center mt-3">
  <div>
    <label>Show:
      <select class="form-select d-inline w-auto ms-2" [(ngModel)]="pageSize" (change)="changePageSize(pageSize)">
        <option *ngFor="let size of pageSizeOptions" [ngValue]="size">{{ size }}</option>
      </select>
      entries
    </label>
  </div>

  <div>
    <button class="btn btn-outline-secondary btn-sm me-2"
            (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1">
      Previous
    </button>

    <span>Page {{ currentPage }} of {{ totalPages }}</span>

    <button class="btn btn-outline-secondary btn-sm ms-2"
            (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages">
      Next
    </button>
  </div>
</div>