<div class="card shadow-sm">
  <div class="container-fluid py-4 roles-page">

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
       <h4 class="fw-semibold mb-0">
  <i class="fa-solid fa-users-gear me-2 text-danger"></i>
  Role Management
</h4>
        <small class="text-muted ms-4">Create, update, and manage user roles.</small>
      </div>
      <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#addRoleModal">
        <i class="fa fa-plus me-2"></i>Add Role
      </button>
    </div>

    <!-- Roles Table -->
    <div class="card shadow-sm border-0">
      <div class="card-header bg-light fw-semibold d-flex justify-content-between align-items-center">
        <span>Existing Roles</span>

        <!-- Page size selector -->
        <div>
          <select class="form-select form-select-sm" style="width: auto;"
            [(ngModel)]="pageSize" (change)="onPageSizeChange(pageSize)">
            <option *ngFor="let size of pageSizes" [value]="size">{{ size }}</option>
          </select>
        </div>
      </div>

      <div class="card-body p-0">
        <table class="table table-hover table-bordered align-middle mb-0">
          <thead class="table-secondary">
            <tr>
              <th (click)="toggleSort('roleId')" class="cursor-pointer">#</th>
              <th (click)="toggleSort('roleName')" class="cursor-pointer">Role Name</th>
              <th (click)="toggleSort('roleDescription')" class="cursor-pointer">Description</th>
              <th (click)="toggleSort('isActive')" class="cursor-pointer">Status</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let r of roles; let i = index">
              <td>{{ (pageNumber - 1) * pageSize + i + 1 }}</td>
              <td>{{ r.roleName }}</td>
              <td>{{ r.roleDescription || '-' }}</td>
              <td>
                <span [class]="'badge ' + (r.isActive ? 'bg-success' : 'bg-secondary')">
                  {{ r.isActive ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-primary me-2" (click)="editRole(r)">
                  <i class="fa fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" (click)="deleteRole(r)">
                  <i class="fa fa-trash"></i>
                </button>
              </td>
            </tr>

            <tr *ngIf="roles.length === 0">
              <td colspan="5" class="text-center text-muted py-3">No roles found.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="card-footer bg-white d-flex justify-content-between align-items-center">
        <small class="text-muted">
          Showing {{ (pageNumber - 1) * pageSize + 1 }} -
          {{ Math.min(pageNumber * pageSize, totalCount) }} of {{ totalCount }} roles
        </small>

        <nav>
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item" [class.disabled]="pageNumber === 1">
              <a class="page-link" (click)="onPageChange(pageNumber - 1)">Previous</a>
            </li>

            <li
              class="page-item"
              *ngFor="let page of [].constructor(Math.ceil(totalCount / pageSize)); let p = index"
              [class.active]="pageNumber === p + 1"
            >
              <a class="page-link" (click)="onPageChange(p + 1)">{{ p + 1 }}</a>
            </li>

            <li class="page-item" [class.disabled]="pageNumber >= totalCount / pageSize">
              <a class="page-link" (click)="onPageChange(pageNumber + 1)">Next</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>

    <!-- Add/Edit Role Modal -->
    <div class="modal fade" id="addRoleModal" tabindex="-1" aria-labelledby="addRoleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="addRoleModalLabel">
              {{ isEditMode ? 'Edit Role' : 'Add New Role' }}
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>

          <form (ngSubmit)="onSubmit()" #roleForm="ngForm">
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label fw-semibold">Role Name</label>
                <input type="text" class="form-control"
                  [(ngModel)]="role.roleName" name="roleName"
                  placeholder="Enter role name" required />
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">Description</label>
                <textarea class="form-control" rows="2"
                  [(ngModel)]="role.roleDescription" name="roleDescription"
                  placeholder="Enter description"></textarea>
              </div>

              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="roleActive"
                  [(ngModel)]="role.isActive" name="isActive" />
                <label class="form-check-label" for="roleActive"> Active </label>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger" [disabled]="!roleForm.valid">
                {{ isEditMode ? 'Update Role' : 'Save Role' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Permissions Section -->
    <div class="card shadow-sm mt-4">
      <div class="card-header d-flex justify-content-between align-items-center bg-dark text-white">
        <h5 class="mb-0">Roles & Permissions</h5>
        <div>
          <select class="form-select form-select-sm role-select" (change)="fnChangeRoles($event)">
            <option selected disabled>Select Role</option>
            <option *ngFor="let r of roles" [value]="r.roleId">{{ r.roleName }}</option>
          </select>
        </div>
      </div>

      <div class="card-body">
     <div class="card-body">
  <div class="table-responsive">
    <table class="table table-bordered align-middle text-center permission-table">
      <thead class="table-secondary">
        <tr>
          <th style="width: 250px;">Module</th>
          <th style="width: 250px;">Submodule</th>
          <th *ngFor="let action of actions">{{ action | titlecase }}</th>
        </tr>
      </thead>

      <tbody>
        <ng-container *ngFor="let module of permissions">
          <!-- MODULE ROW -->
          <tr [class.expanded-row]="module.expanded">
            <!-- Module Column -->
            <td class="text-start">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <input
                    type="checkbox"
                    class="form-check-input me-2"
                  
                     [checked]="hasAnyPermission(module)"
                    (change)="toggleModulePermissionsWithSelect(module, $event)"
                  />
                  <strong>{{ module.name }}</strong>
                </div>

                <!-- Arrow only if children exist -->
                <button
                  *ngIf="module.children?.length"
                  class="btn btn-sm btn-outline-secondary"
                  (click)="toggleModule(module)"
                >
                  <i
                    class="fas"
                    [ngClass]="{
                      'fa-chevron-down': module.expanded,
                      'fa-chevron-right': !module.expanded
                    }"
                  ></i>
                </button>
              </div>
            </td>

            <!-- Submodule Column -->
            <td *ngIf="!module.children?.length"></td>

            <!-- Permissions for modules without children -->
            <ng-container *ngIf="!module.children?.length">
              <td *ngFor="let action of actions">
                <input
                  type="checkbox"
                   class="form-check-input me-2"
                  [(ngModel)]="module.permissions[action]"
                     [checked]="hasAnyPermission(module)"
                  (change)="updateParentStatus(module)"
                />
              </td>
            </ng-container>

            <!-- If has children and not expanded: show message -->
            <td [attr.colspan]="actions.length + 1" class="text-center text-muted small" *ngIf="module.children?.length && !module.expanded">
              Click arrow to expand submodules
            </td>
          </tr>

          <!-- Submodules / Under-submodules -->
          <ng-container *ngIf="module.expanded && module.children?.length">
            <ng-container *ngTemplateOutlet="menuLevel; context: { menus: module.children, parent: module, level: 1 }"></ng-container>
          </ng-container>
        </ng-container>
      </tbody>
    </table>
  </div>

  <div class="text-end mt-3">
    <button class="btn btn-secondary me-2" (click)="resetPermissions()">Reset</button>
    <button class="btn btn-danger" (click)="savePermissions()">Save Permissions</button>
  </div>
</div>

<!-- Recursive Template -->
<ng-template #menuLevel let-menus="menus" let-parent="parent" let-level="level">
  <ng-container *ngFor="let menu of menus">
    <tr [class.expanded-row]="menu.expanded">
      <!-- Module Column (shows parent name) -->
      <td *ngIf="level === 1" class="text-start text-muted">
       
      </td>
      <td *ngIf="level > 1"></td>

      <!-- Submodule Column -->
      <td [style.paddingLeft.px]="level * 25" class="text-start">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <input
              type="checkbox"
              class="form-check-input me-2"
             
               [checked]="hasAnyPermission(menu)"
               (change)="toggleModulePermissionsWithSelect(menu, $event)"
            />
            {{ menu.name }}
          </div>

          <!--  [(ngModel)]="menu.selected" Show expand button only if children -->
          <button
            *ngIf="menu.children?.length"
            class="btn btn-sm btn-outline-secondary"
            (click)="toggleModule(menu)"
          >
            <i
              class="fas"
              [ngClass]="{
                'fa-chevron-down': menu.expanded,
                'fa-chevron-right': !menu.expanded
              }"
            ></i>
          </button>
        </div>
      </td>

      <!-- If no children: show checkboxes -->
      <ng-container *ngIf="!menu.children?.length">
        <td *ngFor="let action of actions">
          <input
            type="checkbox"
             class="form-check-input me-2"
            [(ngModel)]="menu.permissions[action]"
               [checked]="hasAnyPermission(menu)"
            (change)="updateParentStatus(menu)"
          />
        </td>
      </ng-container>

      <!-- If has children and not expanded: show message -->
      <td [attr.colspan]="actions.length" class="text-center text-muted small" *ngIf="menu.children?.length && !menu.expanded">
        Click arrow to expand submodules
      </td>
    </tr>

    <!-- Recursive call -->
    <ng-container *ngIf="menu.expanded && menu.children?.length">
      <ng-container *ngTemplateOutlet="menuLevel; context: { menus: menu.children, parent: parent, level: level + 1 }"></ng-container>
    </ng-container>
  </ng-container>
</ng-template>

      </div>
    </div>
  </div>
</div>
